# On Tracis CI:
# The job exceeded the maximum time limit for jobs, and has been terminated.

# sudo apt-get update
# sudo apt-get -y install git mercurial
yum -y install mercurial git || true

# Update tp Python 2.7
yum install -y centos-release-scl
yum install -y python27

# Workaround for:
# *** MERCURIAL NOT CONFIGURED ***
export NO_MERCURIAL_SETUP_CHECK=1

# https://developer.mozilla.org/en-US/docs/Mozilla/Developer_guide/Build_Instructions/Linux_Prerequisites
# Install all system prerequisites
wget -O bootstrap.py https://hg.mozilla.org/mozilla-central/raw-file/default/python/mozboot/bin/bootstrap.py 

python bootstrap.py --application-choice=browser --no-interactive

# Only continue if we get:
# "Your system should be ready to build Firefox for Desktop!"

# Get mozilla-central from Mozilla through Mercurial
REV=$(wget -q https://github.com/therealglazou/bluegriffon/raw/bg2/config/mozilla_central_revision.txt -O -)
hg clone http://hg.mozilla.org/mozilla-central bluegriffon-source -r $REV
# TODO: http://stackoverflow.com/questions/14872486/retrieve-specific-commit-from-a-remote-git-repository
# git clone https://github.com/mozilla/gecko-dev bluegriffon-source ...

# Get BlueGriffon's tree through
cd bluegriffon-source
git clone -b bg2 --single-branch https://github.com/therealglazou/bluegriffon --depth 1

patch -p 1 < bluegriffon/config/content.patch

# Workaround for:
cp ./bluegriffon/config/mozconfig.ubuntu .mozconfig
sed -i -e 's|^mk_add_options MOZ_OBJDIR|#mk_add_options MOZ_OBJDIR|g' .mozconfig

# build the bluegriffon-ng or the bg2 branch
./mach build
