# Now we are inside CentOS 6
grep -r "CentOS release 6" /etc/redhat-release || exit 1

git_pull_rebase_helper()
{
	GITCLEAN=$(git diff --shortstat 2> /dev/null | tail -n1)
	if [ "x$GITCLEAN" != "x" ] ; then
		git stash save
		git pull --rebase
		git stash pop
	else
		git pull --rebase
	fi
}

# Workaround for:
# checking for QT4... no
# configure: error: Qt4 not found
# We need at least Qt 4.8, hence we get it from kde.repo
wget http://kdeforge.unl.edu/apt/kde-redhat/epel/kde.repo -O /etc/yum.repos.d/kde.repo

# Some packages (e.g. ffmpeg) are not in the official repository, but can be installed from the rpmfusion repository

yum localinstall -y --nogpgcheck http://download1.rpmfusion.org/free/el/updates/6/i386/rpmfusion-free-release-6-1.noarch.rpm http://download1.rpmfusion.org/nonfree/el/updates/6/i386/rpmfusion-nonfree-release-6-1.noarch.rpm

sudo yum -y install ffmpeg-devel qt4-devel alsa-lib-devel pulseaudio-libs-devel jack-audio-connection-kit-devel \
gcc make gcc-c++ glibc-devel.i686 libgcc.i686 libX11-devel libX11-devel.i686 libXext-devel libXext-devel.i686 \
libXfixes-devel libXfixes-devel.i686 mesa-libGL-devel mesa-libGL-devel.i686 mesa-libGLU-devel mesa-libGLU-devel.i686 mesa-libGLU-devel.x86_64 qt4

git clone https://github.com/MaartenBaert/ssr.git

if [ ! -d ssr ] ; then
  git clone https://github.com/MaartenBaert/ssr.git
fi
cd ssr/
git_pull_rebase_helper

# We build as root
sed -i -e 's/root/xroot/g' simple-build-and-install 

# Workaround for:
# Global.h:50: error: variable or field 'atomic_thread_fence_replacement' declared void
# We need at least GCC 4.4 for atomic support, hence we use devtoolset-2
. /opt/rh/devtoolset-2/enable

./simple-build-and-install

# Workaround for:
# /opt/rh/devtoolset-2/root/usr/libexec/gcc/x86_64-redhat-linux/4.8.2/ld: cannot find -lQtCore
# But:
# pkg-config --list-all | grep QtCore
# QtCore                     Qtcore - Qtcore Library
# Found the issue with:
# ld -lQtCore --verbose
# Turns out /usr/lib64/libQtCore.so was missing, as the qt4 package was not installed

# Workaround for:
# cannot find -lstdc++_nonshared
# Still missing! (FIXME)

exit 1

# Looks like it is picking up the 64-bit libstdc++ instead of the 32-bit one?

make[2]: Entering directory `/ssr/build32/glinject'
/bin/sh ../libtool  --tag=CXX   --mode=link g++ -m32 -pthread -fPIC -std=c++0x -Wall -O2 -pipe -pthread -fPIC -avoid-version -shared -lrt -ldl -lGL -lGLU -lX11 -lXfixes  -o libssr-glinject.la -rpath /usr/lib libssr_glinject_la-elfhacks.lo libssr_glinject_la-GLInject.lo libssr_glinject_la-GLXFrameGrabber.lo libssr_glinject_la-Hook.lo libssr_glinject_la-SSRVideoStreamWriter.lo  
libtool: link: g++ -m32  -fPIC -DPIC -shared -nostdlib /usr/lib/../lib/crti.o /opt/rh/devtoolset-2/root/usr/lib/gcc/x86_64-redhat-linux/4.8.2/32/crtbeginS.o  .libs/libssr_glinject_la-elfhacks.o .libs/libssr_glinject_la-GLInject.o .libs/libssr_glinject_la-GLXFrameGrabber.o .libs/libssr_glinject_la-Hook.o .libs/libssr_glinject_la-SSRVideoStreamWriter.o   -lrt -ldl -lGL -lGLU -lX11 -lXfixes -L/opt/rh/devtoolset-2/root/usr/lib/gcc/x86_64-redhat-linux/4.8.2/32 -L/opt/rh/devtoolset-2/root/usr/lib/gcc/x86_64-redhat-linux/4.8.2/../../../../lib -L/lib/../lib -L/usr/lib/../lib -L/opt/rh/devtoolset-2/root/usr/lib/gcc/x86_64-redhat-linux/4.8.2 -L/opt/rh/devtoolset-2/root/usr/lib/gcc/x86_64-redhat-linux/4.8.2/../../.. -lstdc++ -lm -lc -lgcc_s /opt/rh/devtoolset-2/root/usr/lib/gcc/x86_64-redhat-linux/4.8.2/32/crtendS.o /usr/lib/../lib/crtn.o  -m32 -pthread -O2 -pthread   -pthread -Wl,-soname -Wl,libssr-glinject.so -o .libs/libssr-glinject.so
/opt/rh/devtoolset-2/root/usr/libexec/gcc/x86_64-redhat-linux/4.8.2/ld: skipping incompatible /opt/rh/devtoolset-2/root/usr/lib/gcc/x86_64-redhat-linux/4.8.2/libstdc++_nonshared.a when searching for -lstdc++_nonshared
/opt/rh/devtoolset-2/root/usr/libexec/gcc/x86_64-redhat-linux/4.8.2/ld: skipping incompatible /opt/rh/devtoolset-2/root/usr/lib/gcc/x86_64-redhat-linux/4.8.2/libstdc++_nonshared.a when searching for -lstdc++_nonshared
/opt/rh/devtoolset-2/root/usr/libexec/gcc/x86_64-redhat-linux/4.8.2/ld: cannot find -lstdc++_nonshared
collect2: error: ld returned 1 exit status
make[2]: *** [libssr-glinject.la] Error 1
make[2]: Leaving directory `/ssr/build32/glinject'
make[1]: *** [all-recursive] Error 1
make[1]: Leaving directory `/ssr/build32'
make: *** [all] Error 2
