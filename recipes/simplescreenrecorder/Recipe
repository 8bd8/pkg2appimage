# Now we are inside CentOS 6
grep -r "CentOS release 6" /etc/redhat-release || exit 1

git_pull_rebase_helper()
{
	GITCLEAN=$(git diff --shortstat 2> /dev/null | tail -n1)
	if [ "x$GITCLEAN" != "x" ] ; then
		git stash save
		git pull --rebase
		git stash pop
	else
		git pull --rebase
	fi
}

# Workaround for:
# cannot find -lstdc++_nonshared
# Force-install devtoolset-2-libstdc++-devel i686
cd /
wget http://people.centos.org/~tru/devtools-2/6/i386/RPMS/devtoolset-2-libstdc++-devel-4.8.2-15.el6.i686.rpm -O - | rpm2cpio | cpio -idm
cd -

# Workaround for:
# checking for QT4... no
# configure: error: Qt4 not found
# We need at least Qt 4.8, hence we get it from kde.repo
wget http://kdeforge.unl.edu/apt/kde-redhat/epel/kde.repo -O /etc/yum.repos.d/kde.repo

# Some packages (e.g. ffmpeg) are not in the official repository, but can be installed from the rpmfusion repository

yum localinstall -y --nogpgcheck http://download1.rpmfusion.org/free/el/updates/6/i386/rpmfusion-free-release-6-1.noarch.rpm http://download1.rpmfusion.org/nonfree/el/updates/6/i386/rpmfusion-nonfree-release-6-1.noarch.rpm

sudo yum -y install ffmpeg-devel qt4-devel alsa-lib-devel pulseaudio-libs-devel jack-audio-connection-kit-devel \
gcc make gcc-c++ glibc-devel.i686 libgcc.i686 libX11-devel libX11-devel.i686 libXext-devel libXext-devel.i686 \
libXfixes-devel libXfixes-devel.i686 mesa-libGL-devel mesa-libGL-devel.i686 mesa-libGLU-devel mesa-libGLU-devel.i686 mesa-libGLU-devel.x86_64 qt4

git clone https://github.com/MaartenBaert/ssr.git

if [ ! -d ssr ] ; then
  git clone https://github.com/MaartenBaert/ssr.git
fi
cd ssr/
git_pull_rebase_helper

# We build as root
sed -i -e 's/root/xroot/g' simple-build-and-install 

# Workaround for:
# Global.h:50: error: variable or field 'atomic_thread_fence_replacement' declared void
# We need at least GCC 4.4 for atomic support, hence we use devtoolset-2
sudo wget http://people.centos.org/tru/devtools-2/devtools-2.repo -O /etc/yum.repos.d/devtools-2.repo
sudo yum -y install devtoolset-2-gcc devtoolset-2-gcc-c++ devtoolset-2-binutils
. /opt/rh/devtoolset-2/enable

./simple-build-and-install

# Workaround for:
# /opt/rh/devtoolset-2/root/usr/libexec/gcc/x86_64-redhat-linux/4.8.2/ld: cannot find -lQtCore
# But:
# pkg-config --list-all | grep QtCore
# QtCore                     Qtcore - Qtcore Library
# Found the issue with:
# ld -lQtCore --verbose
# Turns out /usr/lib64/libQtCore.so was missing, as the qt4 package was not installed
