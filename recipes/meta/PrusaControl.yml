app: PrusaControl

ingredients:
  dist: trusty
  sources:
    - deb http://archive.ubuntu.com/ubuntu/ trusty main universe
  packages:
    - python3.4-minimal
    - python3-pyqt4.qtopengl
  script:
    - wget -c "https://github.com/prusa3d/PrusaControl/archive/master.tar.gz"
    - sudo apt-get install -y python-virtualenv gcc python3.4-dev python3.4-minimal python3-pip libz-dev libjpeg-dev # Only on the build host
    - virtualenv venv -p $(which python3.4) --always-copy
    - venv/bin/pip  install numpy numpy-stl pyrr PyOpenGL PyOpenGL-accelerate Pillow # How would we do this on OBS?
    - DLD=$(wget -q "https://github.com/prusa3d/Slic3r/releases" -O - | grep "/prusa3d/Slic3r/releases.*Slic3r.*AppImage" | head -n 1 |  cut -d '"' -f 2)
    - wget -c "https://github.com$DLD"
    - chmod +x *.AppImage

script:
  - tar xf ../master.tar.gz
  - cp -Rf ../venv/lib/python3.*/site-packages/* usr/lib/python3/dist-packages/
  - cat > prusacontrol.desktop <<\EOF
  - [Desktop Entry]
  - Name=PrusaControl
  - Icon=prusacontrol
  - Exec=prusacontrol
  - Categories=Graphics;
  - Type=Application
  - EOF
  - cat > usr/bin/prusacontrol <<\EOF
  - #!/bin/bash
  - set +x
  - HERE="$(dirname "$(readlink -f "${0}")")"
  - APPDIR=$(readlink -f "$HERE/../../")
  - export PYTHONPATH="$APPDIR/usr"
  - export PATH="$APPDIR/usr/bin":$PATH
  - cd "$APPDIR/PrusaControl-master"
  - exec "$APPDIR/usr/bin/python3" ./main.pyc
  - EOF
  - chmod a+x usr/bin/prusacontrol
  - cp ./PrusaControl-master/data/icon/favicon_32.png ./usr/share/icons/hicolor/32x32/apps/prusacontrol.png
  - cp ./PrusaControl-master/data/icon/favicon_64.png ./usr/share/icons/hicolor/64x64/apps/prusacontrol.png
  - cp ./PrusaControl-master/data/icon/favicon_128.png ./usr/share/icons/hicolor/128x128/apps/prusacontrol.png
  - cp ./PrusaControl-master/data/icon/favicon_256.png ./usr/share/icons/hicolor/256x256/apps/prusacontrol.png
  - cp ./usr/share/icons/hicolor/256x256/apps/prusacontrol.png .
  - # cp PrusaControl-master/data/v.txt ../VERSION
  - # sed -i -e 's|v||g' ../VERSION
  - echo $TRAVIS_BUILD_NUMBER > ../VERSION
  - find . -iname '*Tk*' -exec rm -rf {} \; || true
  - find . -iname '*QtNetwork*' -exec rm -rf {} \; || true
  - find . -iname '*QtSql*' -exec rm -rf {} \; || true
  - find . -iname '*QtSvg*' -exec rm -rf {} \; || true
  - find . -iname '*QtXml*' -exec rm -rf {} \; || true
  - find . -iname '*lib2to3*' -exec rm -rf {} \; || true
  - find . -iname '*QtTest*' -exec rm -rf {} \; || true
  - find . -iname '*QtDesigner*' -exec rm -rf {} \; || true
  - find . -iname '*QtHelp*' -exec rm -rf {} \; || true
  - find . -iname '*QtScript*' -exec rm -rf {} \; || true
  - find . -iname '*Webkit*' -exec rm -rf {} \; || true
  - find . -iname '*QtAssistant*' -exec rm -rf {} \; || true
  - find . -iname '*ucene*' -exec rm -rf {} \; || true
  - find . -iname '*pip*' -exec rm -rf {} \; || true
  - find . -iname '*setuptools*' -exec rm -rf {} \; || true
  - find . -iname '*declarative*' -exec rm -rf {} \; || true
  - rm -rf usr/share/locale/
  - ../Slic3r-*.AppImage --appimage-extract
  - rm ../Slic3r-*.AppImage
  - mkdir -p PrusaControl-master/tools/Slic3r-Lite
  - cp -Rf squashfs-root/usr/* PrusaControl-master/tools/Slic3r-Lite/
  - rm -rf squashfs-root/
  - rm -rf lib/x86_64-linux-gnu/libreadline.so.6
  - ./usr/bin/python3 -m compileall . -fqb # Compile all python code for speed
  - find . -name '*.py' -exec rm -rf {} \; || true # Then remove the original python files for size
  - find . -name '*.spec' -exec rm -rf {} \; || true
  - rm -rf ./PrusaControl-master/ts || true
  - rm -rf ./PrusaControl-master/doc || true
  - rm -rf ./PrusaControl-master/.git/ || true
  - rm -rf ./PrusaControl-master/.idea/ || true
  - rm -rf ./etc
  - rm -rf ./lib/x86_64-linux-gnu/libbz2.so.1
  - rm -rf ./lib/x86_64-linux-gnu/libgcrypt.so.11
  - rm -rf ./lib/x86_64-linux-gnu/libgcrypt.so.11.8.2
  - rm -rf ./lib/x86_64-linux-gnu/libhistory.so.6
  - rm -rf ./lib/x86_64-linux-gnu/libhistory.so.6.3
  - rm -rf ./lib/x86_64-linux-gnu/libncursesw.so.5
  - rm -rf ./lib/x86_64-linux-gnu/libncursesw.so.5.9
  - rm -rf ./lib/x86_64-linux-gnu/libreadline.so.6.3
  - rm -rf ./PrusaControl-master/tools/Slic3r-Lite/bin/bin/libglut.so.3
  - rm -rf ./PrusaControl-master/tools/Slic3r-Lite/bin/bin/libglut.so.3.9.0
  - rm -rf ./PrusaControl-master/tools/Slic3r-Lite/bin/bin/libjpeg.so.62
  - rm -rf ./PrusaControl-master/tools/Slic3r-Lite/bin/bin/libjpeg.so.62.1.0
  - rm -rf ./PrusaControl-master/tools/Slic3r-Lite/bin/bin/liblzma.so.5
  - rm -rf ./PrusaControl-master/tools/Slic3r-Lite/bin/bin/liblzma.so.5.0.0
  - rm -rf ./PrusaControl-master/tools/Slic3r-Lite/bin/bin/libtiff.so.5
  - rm -rf ./PrusaControl-master/tools/Slic3r-Lite/bin/bin/libtiff.so.5.2.0
  - rm -rf ./PrusaControl-master/tools/Slic3r-Lite/bin/bin/libwx_baseu-3.0.so
  - rm -rf ./PrusaControl-master/tools/Slic3r-Lite/bin/bin/libwx_gtk2u_adv-3.0.so
  - rm -rf ./PrusaControl-master/tools/Slic3r-Lite/bin/bin/libwx_gtk2u_adv-3.0.so.0
  - rm -rf ./PrusaControl-master/tools/Slic3r-Lite/bin/bin/libwx_gtk2u_adv-3.0.so.0.2.0
  - rm -rf ./PrusaControl-master/tools/Slic3r-Lite/bin/bin/libwx_gtk2u_core-3.0.so
  - rm -rf ./PrusaControl-master/tools/Slic3r-Lite/bin/bin/libwx_gtk2u_gl-3.0.so
  - rm -rf ./PrusaControl-master/tools/Slic3r-Lite/bin/bin/libwx_gtk2u_html-3.0.so
  - rm -rf ./PrusaControl-master/tools/Slic3r-Lite/bin/bin/libX11.so.6.3.0
  - rm -rf ./PrusaControl-master/tools/Slic3r-Lite/bin/bin/var
  - rm -rf ./PrusaControl-master/tools/Slic3r-Lite/share
  - rm -rf ./PrusaControl-master/tools/Slic3r-Lite/src
  - rm -rf ./usr/bin/2to3-3.4
  - rm -rf ./usr/bin/assistant
  - rm -rf ./usr/bin/designer
  - rm -rf ./usr/bin/dh_pypy
  - rm -rf ./usr/bin/dh_python3
  - rm -rf ./usr/bin/lconvert
  - rm -rf ./usr/bin/linguist
  - rm -rf ./usr/bin/lrelease
  - rm -rf ./usr/bin/lupdate
  - rm -rf ./usr/bin/moc
  - rm -rf ./usr/bin/pdb3
  - rm -rf ./usr/bin/pdb3.4
  - rm -rf ./usr/bin/pixeltool
  - rm -rf ./usr/bin/py3clean
  - rm -rf ./usr/bin/py3compile
  - rm -rf ./usr/bin/py3versions
  - rm -rf ./usr/bin/pybuild
  - rm -rf ./usr/bin/pydoc3
  - rm -rf ./usr/bin/pydoc3.4
  - rm -rf ./usr/bin/pygettext3
  - rm -rf ./usr/bin/pygettext3.4
  - rm -rf ./usr/bin/python3.4m
  - rm -rf ./usr/bin/python3m
  - rm -rf ./usr/bin/pyvenv-3.4
  - rm -rf ./usr/bin/q*
  - rm -rf ./usr/bin/rcc
  - rm -rf ./usr/bin/uic
  - rm -rf ./usr/bin/uic3
  - rm -rf ./usr/bin/X11
  - rm -rf ./usr/bin/xmlpatterns
  - rm -rf ./usr/bin/xmlpatternsvalidator
  - rm -rf ./usr/lib/x86_64-linux-gnu/gstreamer1.0
  - rm -rf ./usr/lib/x86_64-linux-gnu/libdb-5.3.so
  - rm -rf ./usr/lib/x86_64-linux-gnu/libexpatw.so.1
  - rm -rf ./usr/lib/x86_64-linux-gnu/libexpatw.so.1.6.0
  - rm -rf ./usr/lib/x86_64-linux-gnu/libexslt.so.0
  - rm -rf ./usr/lib/x86_64-linux-gnu/libexslt.so.0.8.17
  - rm -rf ./usr/lib/x86_64-linux-gnu/libformw.so.5
  - rm -rf ./usr/lib/x86_64-linux-gnu/libformw.so.5.9
  - rm -rf ./usr/lib/x86_64-linux-gnu/libgst*
  - rm -rf ./usr/lib/x86_64-linux-gnu/libmenuw.so.5
  - rm -rf ./usr/lib/x86_64-linux-gnu/libmenuw.so.5.9
  - rm -rf ./usr/lib/x86_64-linux-gnu/liborc-0.4.so.0
  - rm -rf ./usr/lib/x86_64-linux-gnu/liborc-0.4.so.0.18.0
  - rm -rf ./usr/lib/x86_64-linux-gnu/liborc-test-0.4.so.0
  - rm -rf ./usr/lib/x86_64-linux-gnu/liborc-test-0.4.so.0.18.0
  - rm -rf ./usr/lib/x86_64-linux-gnu/libpanelw.so.5
  - rm -rf ./usr/lib/x86_64-linux-gnu/libpanelw.so.5.9
  - rm -rf ./usr/share/dh-python
  - rm -rf ./usr/share/doc
  - rm -rf ./usr/share/gst-plugins-base
  - rm -rf ./usr/share/lintian
  - rm -rf ./usr/share/man
  - rm -rf ./usr/share/python3
  - rm -rf ./usr/share/qt4
  - rm -rf ./usr/share/qtchooser
  - rm -rf ./usr/share/X11
  - rm -rf ./usr/share/xml
