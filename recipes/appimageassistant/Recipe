
git_pull_rebase_helper()
{
  git reset --hard HEAD
  git pull
}

if [ -z "$NO_DOWNLOAD" ] ; then
  sudo apt-add-repository -y ppa:vala-team/ppa
  sudo apt-get update -qq
  sudo apt-get install -qq libfuse-dev libglib2.0-dev cmake libc6-dev binutils valac libgee-0.8-dev gcc-multilib g++-multilib libc6-dev-i386
fi

if [ ! -d AppImageKit ] ; then
  git clone https://github.com/probonopd/AppImageKit.git
fi
cd AppImageKit/
git_pull_rebase_helper

cd ./LibcWrapGenerator
valac --pkg gee-0.8 --pkg posix --pkg glib-2.0 --pkg gio-2.0 ./LibcWrapGenerator.vala
sudo ./LibcWrapGenerator --target 2.4 --libdir /lib --output libcwrap.h
sudo cp ./libcwrap.h /usr/include/
cd -
export CC='gcc -U_FORTIFY_SOURCE -include /usr/include/libcwrap.h'
cmake . && make

VERSION=$(git describe | sed -e 's/-/./g')

